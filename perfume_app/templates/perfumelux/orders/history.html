{% extends 'perfumelux/base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <h1 style="margin-bottom: 30px;">Order History</h1>

    {% if page_obj %}
    <div class="neu-outset" style="border-radius: 20px; padding: 25px;">
        {% for order in page_obj %}
        <div class="order-item neu-inset" style="padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                <div>
                    <h3 style="margin-bottom: 5px;">Order #{{ order.id }}</h3>
                    <p style="color: #666;">Placed on {{ order.created_at|date:"F j, Y" }}</p>
                </div>

                <div style="text-align: right;">
                    <p style="font-weight: 700; color: var(--accent-color); margin-bottom: 5px;">${{ order.total_price }}</p>
                    <span class="status-badge" style="padding: 5px 12px; border-radius: 20px; font-size: 12px; background: 
                        {% if order.status == 'delivered' %}var(--success-color)
                        {% elif order.status == 'shipped' %}var(--accent-color)
                        {% elif order.status == 'processing' %}var(--warning-color)
                        {% else %}var(--secondary-color)
                        {% endif %}; color: white;">
                        {{ order.status|default:"Processing"|title }}
                    </span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 15px;">
                <div>
                    <p style="font-weight: 600; margin-bottom: 5px;">Shipping Address</p>
                    <p style="color: #666; font-size: 14px;">{{ order.address }}, {{ order.city }}, {{ order.state }} {{ order.zip_code }}</p>
                </div>

                <div>
                    <p style="font-weight: 600; margin-bottom: 5px;">Items</p>
                    <p style="color: #666; font-size: 14px;">{{ order.orderitem_set.count }} item{{ order.orderitem_set.count|pluralize }}</p>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <a href="{% url 'order_detail' order.id %}" class="btn-neu" style="text-decoration: none;">
                    View Order Details
                </a>

                {% if order.status == 'delivered' %}
                <button class="btn-primary" onclick="reorder({{ order.id }})">
                    Reorder
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- Pagination -->
        <div style="margin-top: 30px; display: flex; justify-content: center;">
            <div class="neu-outset" style="display: flex; border-radius: 10px; overflow: hidden;">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="btn-neu" style="border-radius: 0; text-decoration: none;">&laquo; Previous</a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <span class="btn-neu active" style="border-radius: 0; background-color: var(--accent-color); color: white;">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?page={{ num }}" class="btn-neu" style="border-radius: 0; text-decoration: none;">{{ num }}</a>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="btn-neu" style="border-radius: 0; text-decoration: none;">Next &raquo;</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="neu-outset" style="padding: 60px 30px; text-align: center; border-radius: 20px;">
        <div style="font-size: 80px; margin-bottom: 20px;">ðŸ“¦</div>
        <h2 style="margin-bottom: 15px;">No orders yet</h2>
        <p style="margin-bottom: 30px; color: #666;">Your order history will appear here once you place an order.</p>
        <a href="{% url 'product_list' %}" class="btn-primary">Start Shopping</a>
    </div>
    {% endif %}
</div>

<script>
    function reorder(orderId) {
        fetch(`/orders/${orderId}/reorder/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Items added to cart!', 'success');
                // Update cart count
                const cartCount = document.getElementById('cart-count');
                if (cartCount) {
                    cartCount.textContent = data.cart_count;
                }
            } else {
                showNotification('Failed to reorder', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        });
    }
</script>

<style>
    .order-item {
        transition: all 0.3s ease;
    }
    
    .order-item:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}
